<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: #EFEFEF;
  stroke-width: 1px;
  pointer-events: none;
}

#chart{
  width: 100%;
  height: 100%;
  position: fixed;
  top: -10px;
}
#main-text{
  width: 260px;
  font-size: 14px;
  font-family: Lato;
  position: absolute;
  left: 100px;
  top: 430px;
  z-index: -1;
}

.trigger{
  cursor: pointer;
}
.dot{
  /*pointer-events: none;*/
  stroke: none;
  /*opacity: 1;*/
  fill: #EFEFEF;
  pointer-events: none; 

}
.mouseoverText{
  font-size: 12px;
  font-family: Lato;
  pointer-events: none;
}
.mouseoverBackground{
  fill: #fff;
  pointer-events: none;
}

.x.axis{
  display: none;
}

.line.actual{
  stroke: #1696d2 !important;
}
.line.noPolicy{
  stroke: #333 !important;
}
.line.selected{
  stroke: #ec008c !important;
  /*pointer-events: visible;  */
}
.line.highlighted{
  stroke: #868686;
  /*pointer-events: visible;*/

}
.dot.actual{
  fill: #1696d2 !important;
}
.dot.noPolicy{
  fill: #333 !important;
}
.dot.selected{
  fill: #ec008c !important;
  /*pointer-events: visible;*/
}
.dot.highlighted{
  fill: #868686;
  /*pointer-events: visible;*/
}

.trigger{
  pointer-events: none;
}
.highlighted .trigger, .selected .trigger, .actual .trigger, .noPolicy .trigger{
  pointer-events: visible;
}

/*.trigger.on{
  pointer-events: visible;
}
.trigger.off{
  pointer-events: none;
}
*/

/*Dropdowns*/
.styled-select select {
   background: transparent;
   width: 268px;
   padding: 5px;
   font-size: 16px;
   line-height: 1;
   border: 0;
   border-radius: 0;
   height: 34px;
   -webkit-appearance: none;
}

.styled-select {
   width: 240px;
   height: 34px;
   overflow: hidden;
   background: url(new_arrow.png) no-repeat right #ddd;
   border: 1px solid #ccc;
   z-index: 2;
   position: absolute;
}

.amount-type{
  left: 600px;
}
.reduction-type{
  left: 300px;
}

</style>
<body>
<div class="offender-type styled-select">
 <select>
    <option value = "">Filter by admission type</option>
    <option value = "violent">Violent admissions</option>
    <option value = "nonviolent">Nonviolent admissions</option>
    <option value = "property">Property admissions</option>
    <option value = "drug">Drug admissions</option>
    <option value = "revocation">Revocation admissions</option>
    <option value = "all">All admissions</option>
 </select>
</div>

<div class="reduction-type styled-select">
 <select>
    <option value = "">Filter by reduction type</option>
    <option value = "new">Reduce new admissions</option>
    <option value = "length">Reduce length of stay</option>
 </select>
</div>

<div class="amount-type styled-select">
 <select>
    <option value = "">Filter by reduction amount</option>
    <option value = "five">Reduce by 5%</option>
    <option value = "fifteen">Reduce by 15%</option>
    <option value = "twentyFive">Reduce by 25%</option>
    <option value = "fifty">Reduce by 50%</option>
 </select>
</div>

<div id = "chart"></div>
<div id = "main-text">
<p>
Bacon ipsum dolor amet venison beef t-bone hamburger tri-tip strip steak beef ribs kevin. Sirloin jerky kielbasa tongue tri-tip chicken capicola pancetta sausage chuck t-bone. Turkey porchetta boudin drumstick shankle ham hock beef sausage pork loin alcatra brisket cow ribeye. Tenderloin landjaeger cupim fatback swine, pig salami rump turkey kevin boudin.
</p>
<p>
Pork chop shoulder frankfurter, pork belly picanha swine kielbasa. Ribeye turkey doner ham hock pastrami flank chuck. T-bone cow filet mignon shoulder spare ribs, landjaeger bacon pancetta strip steak picanha meatball chicken. Ribeye ham t-bone ball tip, venison pork chop pastrami rump meatloaf ham hock jerky boudin. Flank ham tenderloin t-bone prosciutto bacon. Turducken tail sirloin, andouille tenderloin bresaola cow picanha drumstick doner spare ribs pork chop frankfurter.
</p>
<p>
Doner t-bone pork belly boudin, brisket short ribs kevin tenderloin flank leberkas ham prosciutto pork. Pork loin drumstick andouille shoulder picanha ball tip pork. Ground round biltong drumstick filet mignon, sausage capicola spare ribs prosciutto leberkas pork loin turducken. Swine prosciutto pig turkey boudin pancetta turducken. Biltong drumstick andouille pork chop flank. Kevin beef ribs short ribs, filet mignon tri-tip pork chop ham hock sausage pig ground round sirloin swine tongue. Ball tip turducken salami prosciutto pig tri-tip andouille pastrami biltong meatball t-bone ham bacon porchetta pork loin.
</p>
<p>
Landjaeger bacon short ribs leberkas pork belly tongue tenderloin ham strip steak bresaola kielbasa doner cupim beef ribs boudin. Capicola ball tip turkey biltong, kielbasa kevin spare ribs landjaeger. Porchetta bacon sirloin chuck, tri-tip shoulder doner beef ribs andouille hamburger drumstick. Pork loin meatball jerky swine. Shoulder ham jowl, flank pork jerky alcatra. Capicola tail alcatra shoulder, tri-tip beef brisket pastrami spare ribs cupim landjaeger kevin.
</p>
<p>
Leberkas corned beef kevin pork venison. Shank chuck jowl salami ground round pig, tail leberkas pork chop biltong rump. Pastrami swine capicola ribeye, drumstick prosciutto shank shankle picanha. Ball tip pastrami short ribs bacon, beef ribs ground round bresaola ham corned beef.
</p>
<p>
Tenderloin andouille landjaeger ribeye short ribs. Filet mignon frankfurter cupim tail sausage beef ribs pork shoulder pastrami doner spare ribs capicola. Pork loin jowl boudin bacon landjaeger short loin. T-bone chuck alcatra andouille pork loin jerky tenderloin corned beef bacon ball tip filet mignon venison shank salami. Ham hock hamburger pork loin pig, ham picanha alcatra shank flank pancetta shankle tri-tip kielbasa. Alcatra rump pork chop, shankle bresaola pastrami doner ribeye short loin strip steak t-bone cow.
</p>
<p>
Picanha andouille cow turkey brisket landjaeger. Sausage shoulder shankle corned beef biltong. Tail biltong boudin bacon t-bone. Shoulder tenderloin leberkas spare ribs swine flank biltong kielbasa meatball jerky strip steak.
</p>
<p>
Prosciutto turkey leberkas sausage brisket, ball tip porchetta spare ribs flank shoulder cow. Pastrami beef ribs beef biltong. Pork belly biltong bacon doner andouille bresaola frankfurter tenderloin pork chop pork turducken short ribs corned beef meatloaf. Kevin frankfurter pork boudin salami. Pancetta fatback alcatra corned beef.
</p>
<p>
Alcatra pork ball tip meatball corned beef pork chop drumstick t-bone chicken. Shoulder beef leberkas pancetta, corned beef prosciutto bacon filet mignon pork loin rump venison. Landjaeger ground round rump chuck drumstick strip steak boudin chicken pancetta frankfurter tongue turkey beef ribs. Pastrami kevin beef ribs sausage ground round jerky pork belly chuck beef drumstick venison shoulder turkey. Short loin landjaeger pastrami jowl brisket cupim, ground round tenderloin cow.
</p>
<p>
Strip steak shoulder meatball capicola, prosciutto drumstick tenderloin andouille chuck meatloaf turducken doner spare ribs filet mignon bresaola. Ham pork belly landjaeger turkey meatball pig pork chop tongue, kevin short ribs bacon cupim ribeye shank pastrami. Ribeye t-bone pancetta, chuck filet mignon picanha venison shank swine. Ham chuck capicola strip steak pork chop cupim cow brisket alcatra. Leberkas pork chop hamburger venison tenderloin beef porchetta cupim chuck turducken meatloaf ground round short loin.
</p>
<p>
Sausage spare ribs biltong ham frankfurter. Jowl drumstick strip steak, shankle meatloaf shank turkey biltong filet mignon sirloin pancetta hamburger beef swine venison. Leberkas cupim t-bone biltong porchetta. Pork belly tongue brisket ground round jowl.
</p>
<p>
Porchetta spare ribs chicken, bacon hamburger sausage kielbasa beef ribs frankfurter ham shank drumstick pig cow fatback. Flank ribeye picanha meatball jowl jerky. Short ribs bacon meatloaf, pork chop fatback prosciutto beef ribs. Ground round turkey sirloin pastrami. Prosciutto tenderloin hamburger bresaola chicken corned beef frankfurter spare ribs pork belly andouille short ribs. Flank shankle picanha, brisket ball tip tri-tip rump bacon.
</p>
<p>
Kielbasa prosciutto ham hock tri-tip, landjaeger bresaola swine beef. Frankfurter t-bone pancetta jowl picanha sausage. Fatback venison tri-tip, short loin chicken pork belly pig t-bone. Porchetta kevin beef sausage, prosciutto alcatra capicola pork loin bresaola venison picanha pork chop pork belly ham hock. Beef ribs venison pork beef strip steak turducken. Pork ball tip rump, tri-tip strip steak salami cupim capicola alcatra cow kielbasa jerky.
</p>
<p>
Prosciutto pig turducken tongue boudin. Landjaeger rump tri-tip, pork chop strip steak sausage pastrami frankfurter ham hock t-bone shoulder leberkas tenderloin tongue. Andouille filet mignon kielbasa leberkas, turducken ham hock salami. Ham hock boudin shank, pork chop t-bone hamburger turkey. Short loin tri-tip shankle shank, biltong tail rump drumstick hamburger.
</p>
<p>
Biltong corned beef drumstick, swine ball tip ribeye kielbasa venison meatball. Shoulder pork andouille, beef pork chop corned beef bresaola. Cow strip steak tenderloin frankfurter bresaola doner. Drumstick pork chop meatball, frankfurter kielbasa ribeye tongue shankle meatloaf pork brisket biltong venison beef ribs.
</p>
<p>
Shoulder bresaola picanha, filet mignon pancetta ham hock ball tip boudin kevin pastrami chuck brisket frankfurter beef. Shoulder strip steak flank pancetta alcatra. Leberkas ham shoulder filet mignon turkey sirloin. Cow turkey pig meatball.
</p>
<p>
Tail picanha t-bone salami corned beef. Spare ribs kielbasa corned beef prosciutto, short loin alcatra shank kevin bacon sausage. Ribeye beef ribs alcatra shank bresaola pancetta ham hock biltong corned beef brisket frankfurter tongue. Tongue jerky strip steak drumstick. Corned beef jerky beef ball tip t-bone bacon pancetta short ribs chicken boudin. Pancetta salami alcatra meatball turkey, fatback tri-tip pork tail.
</p>
<p>
Pork chop doner chuck bresaola flank bacon pork loin swine shank shankle tongue porchetta pancetta pork belly. Ball tip shoulder ham hock, fatback sirloin landjaeger pork chop. Pancetta turkey filet mignon, strip steak picanha jerky jowl pork pork chop rump tongue. Brisket jerky swine doner, ribeye chicken pastrami. Spare ribs porchetta pork chop cupim jerky venison.
</p>
<p>
Tenderloin meatloaf kielbasa strip steak beef ribs, porchetta salami landjaeger frankfurter ball tip kevin ribeye. Picanha shoulder beef pastrami. Salami prosciutto jowl, landjaeger pork chop sirloin bacon corned beef biltong. Kielbasa pork chop ham short loin shankle short ribs prosciutto strip steak. Cow cupim corned beef, flank chicken leberkas pastrami boudin turducken fatback sausage landjaeger chuck turkey. Kielbasa venison shoulder, tongue t-bone chicken pig. T-bone turkey picanha ground round ham hamburger pastrami short loin bacon strip steak filet mignon spare ribs brisket jerky.
</p>
<p>
Jerky tenderloin bresaola, sausage chuck beef ribs tri-tip drumstick hamburger. Meatball kielbasa turkey, tenderloin doner bacon prosciutto hamburger picanha venison pork spare ribs shank jerky meatloaf. Landjaeger capicola ground round, pork loin kevin swine leberkas. Pork belly turkey brisket flank short loin leberkas, ground round turducken. Cow beef venison andouille porchetta beef ribs shank tri-tip. Shoulder t-bone tri-tip brisket kevin meatball short ribs pastrami spare ribs jowl pancetta biltong turkey jerky. Andouille filet mignon ground round shank kevin.
</p>


</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>
var PINK = "#ec008c"
var BLUE = "#1696d2"
var DARK_GREY = "#868686"
var LIGHT_GREY = "#efefef"
d3.select(window).on('resize', drawGraphic);
  function allPossibleCases(arr) {
  if (arr.length == 1) {
    return arr[0];
  }
  else if (arr.length == 0){
    return arr;
  } else {
    var result = [];
    var allCasesOfRest = allPossibleCases(arr.slice(1));  // recur with the rest of array
    for (var i = 0; i < allCasesOfRest.length; i++) {
      for (var j = 0; j < arr[0].length; j++) {
        result.push(arr[0][j] + allCasesOfRest[i]);
      }
    }
    return result;
  }

}
function selectSeries(offender, reduction, amount){
  var newColor = (offender !== "" && reduction !== "" && amount !== "") ? PINK : DARK_GREY;
  var newClass = (offender !== "" && reduction !== "" && amount !== "") ? "selected" : "highlighted";

  var offenders = [".violent", ".nonviolent", ".all", ".drug", ".property", ".revocation"]
  var reductions = [".new", ".length"]
  var amounts = [".five", ".fifteen", ".twentyFive", ".fifty"]
  var vars = [];

  if(offender !== ""){ offender = "." + offender; vars.push(offenders)}
  if(reduction !== ""){ reduction = "." + reduction; vars.push(reductions)}
  if(amount !== ""){ amount = "." + amount; vars.push(amounts)}
  var combination = offender + reduction + amount;
  combinations = allPossibleCases(vars)
  var index = combinations.indexOf(combination);
  temp = combinations;
  temp.splice(index, 1)

  for (var i = 0; i < temp.length; i++){
      d3.selectAll(".line" + temp[i])
        .transition()
        .duration(1000)
        .style("stroke", LIGHT_GREY)
      d3.selectAll(".dot" + temp[i])
        .transition()
        .duration(1000)
        .style("fill", LIGHT_GREY)
  }
  d3.selectAll(".line" + combination)
    .transition()
    .duration(1000)
    .style("stroke", newColor)
  d3.selectAll(".dot" + combination)
    .transition()
    .duration(1000)
    .style("fill", newColor)

  setTimeout(function(){
    for(var j = 0; j < temp.length; j++){
      d3.selectAll(temp[j])
        .classed("highlighted", false);
      d3.selectAll(temp[j] + " .trigger")
        .classed("highlighted", false);
      d3.selectAll(".selected")
        .classed("selected", false);

      d3.selectAll(combination)
        .classed(newClass, true);
      d3.selectAll(combination + " .trigger")
        .classed(newClass, true);
      d3.selectAll(combination).each(function() { this.parentNode.parentNode.appendChild(this.parentNode); });
      d3.selectAll(".noPolicy").each(function() { this.parentNode.parentNode.appendChild(this.parentNode); });
    }
  }, 400);


}
function drawGraphic(){


  d3.select("#chart svg").remove();
  var margin = {top: 120, right: 80, bottom: 30, left: 50};
  var PRISONERS = d3.format(",f")
  var DATE = d3.time.format("%b, %Y")
  var PERCENT = d3.format("%")
  var width = window.innerWidth - margin.left - margin.right;
  var height = window.innerHeight - margin.top - margin.bottom;

  var parseDate = d3.time.format("%b-%y").parse;

  var x = d3.time.scale()
      .range([0, width]);
  var y = d3.scale.linear()
      .range([height, 0]);

// var zoom = d3.behavior.zoom()

//     .on("zoom", draw);
//   zoom.y(y)

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("right")
      .tickFormat(function(d){
        return d/1000
      });

  var line = d3.svg.line()
      .defined(function(d) { return d.series != null; })
      .x(function(d) { return x(d.date); })
      .y(function(d) { return y(d.series); });

  var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")


  var gradient = svg.append("svg:defs")
    .append("svg:linearGradient")
      .attr("id", "gradient")
      .attr("x1", "0%")
      .attr("y1", "0%")
      .attr("x2", "0%")
      .attr("y2", "100%")
      .attr("spreadMethod", "pad");

  gradient.append("svg:stop")
      .attr("offset", "0%")
      .attr("stop-color", "#fff")
      .attr("stop-opacity", 1);

  gradient.append("svg:stop")
      .attr("offset", "100%")
      .attr("stop-color", "#fff")
      .attr("stop-opacity", 0);

  svg.append("rect")
      .attr("x",0)
      .attr("y",250)
      .attr("width", 300)
      .attr("height", 148)
      .attr("fill", "url(#gradient)")
  svg.append("rect")
      .attr("x",0)
      .attr("y",-120)
      .attr("width", 300)
      .attr("height", 370)
      .attr("fill", "#fff")

  d3.csv("data/test_data.csv", function(error, data) {
    if (error) throw error;

    data.forEach(function(d) {
      d.date = parseDate(d.date);
    });

    var headers = d3.keys(data[0]).filter(function(key) { return key !== "date"; })
    var series = headers.map(function(name) {
      return {
        name: name,
        values: data.map(function(d) {
          if(d[name] != ""){
            return {date: d.date, series: +d[name]};
          }
           else{
            return {date: null, series: null}
          }
        })
      };
    });


    x.domain(d3.extent(data, function(d) { return d.date; }));

    y.domain([
      0,
      d3.max(series, function(c) { return d3.max(c.values, function(v) { return v.series; }); })
    ]);

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("transform", "translate(" + (width+10) + ",0)")
        .attr("class", "y axis")
        .call(yAxis)
      // .append("text")
      //   .attr("transform", "rotate(-90)")
      //   .attr("y", 6)
      //   .attr("dy", ".71em")
      //   .style("text-anchor", "end")

    var ser = svg.selectAll(".series")
        .data(series)
      .enter().append("g")
        .attr("class", "series");

    series.forEach(function(arr){
      var dots = svg.append("g").selectAll(".dot")
          .data(arr.values)
          .enter().append("g")
          .attr("class", arr.name + " highlighted")
        dots.append("circle")
          .attr("class", "trigger")
          .attr("cx", function(d){ return x(d.date)})
          .attr("cy", function(d){ return y(d.series)})
          .attr("r", 5)
          .attr("opacity", 0)
          .attr("fill", "#fff")
          .on("mouseover", function(d){
           var parent = d3.select(d3.select(this).node().parentNode)
      //append "grandparent" g element to "greatgrandparent" so that the tooltips are above both the series and the dots
           parent.node().parentNode.parentNode.appendChild(parent.node().parentNode)
           parent
              .selectAll("text")
              .transition()
              .duration(100)
              .attr("opacity", 1)
           parent
              .selectAll("rect")
              .transition()
              .duration(200)
              .attr("opacity", .6)

            parent
              .select(".dot")
              .transition()
              .duration(100)
              .attr("r",5)
              .attr("fill", PINK)
            parent.select(".dot").classed("selected", true)

              
          })
          .on("mouseout", function(d){
            var parent = d3.select(d3.select(this).node().parentNode)
            parent
              .selectAll("text")
              .transition()
              .duration(100)
              .attr("opacity", 0)
            parent
              .selectAll("rect")
              .transition()
              .duration(200)
              .attr("opacity", 0)
            parent
              .selectAll(".dot")
              .classed("selected", false)
              .transition()
              .attr("r",2)

              // .attr("fill", BLUE)
          })
          // .append("g")
          dots.append("circle")
            .attr("class", "dot highlighted " + arr.name)
            .attr("cx", function(d){ return x(d.date)})
            .attr("cy", function(d){ return y(d.series)})
            .attr("r", 2)
            .classed("selected", false)
            // .attr("fill", BLUE)

          dots
            .append("rect")
            .attr("class", "mouseoverBackground")
            .attr("x", function(d){ return x(d.date) - 20})
            .attr("y", function(d){ return y(d.series) - 40})
            .attr("width", 70)
            .attr("height", 34)
            .attr("opacity", 0)
          dots
            .append("text")
            .attr("class", "mouseoverText")
            .text(function(d){
              if(d.date !== null){
                return DATE(d.date);
              }
            })
            .attr("x", function(d){ return x(d.date) })
            .attr("y", function(d) {return y(d.series)})
            .attr("dx", "-1em")
            .attr("dy", "-2em")
            .attr("opacity", 0)

          dots
            .append("text")
            .attr("class", "mouseoverText")
            .text(function(d){
              if(d.date !== null){
                return PRISONERS(d.series);
              }
            })
            .attr("x", function(d){ return x(d.date) })
            .attr("y", function(d) {return y(d.series)})
            .attr("dx", "-1em")
            .attr("dy", "-1em")
            .attr("opacity", 0)

        // .attr("dy", ".71em")

    });

    ser.append("path")
        .attr("d", function(d) { return line(d.values); })
        .attr("class", function(d){ return "line highlighted " + d.name})


  });

// setInterval(function() {
//   // if (!timer) return;
//   var translate = zoom.translate(),
//       scale = zoom.scale(),
//       xd = x0.domain(),
//       dx = 1;
//   // Set a new x-domain: offset by dx.
//   xd[0] += dx;
//   xd[1] += dx;
//   x0.domain(xd)
//   // Set the zoom x-domain (this resets the domain at zoom scale=1).
//   zoom.x(x.domain(xd));
//   // Reset the domain relative to the current zoom offsets.
//   x.domain(x0.range().map(function(x) { return (x - translate[0]) / scale; }).map(x0.invert));
//   refresh();
// }, 1e3);

// function refresh() {
//   svg.select(".x.axis").call(xAxis);
//   svg.select(".y.axis").call(yAxis);
//   // drawGraphic();
// }
  function draw() {

    // svg.select("g.x.axis").call(xAxis);
    svg.select(".y.axis").call(yAxis);
    svg.selectAll(".line").attr("d", function(d) { return line(d.values); })
    svg.selectAll(".dot")
      .attr("cx", function(d){ return x(d.date)})
      .attr("cy", function(d){ return y(d.series)})
    svg.selectAll(".mouseoverBackground")
      .attr("x", function(d){ return x(d.date) - 20})
      .attr("y", function(d){ return y(d.series) - 40})

    svg.selectAll(".trigger")
      .attr("cx", function(d){ return x(d.date)})
      .attr("cy", function(d){ return y(d.series)})
    svg.selectAll(".mouseoverText")
      .attr("x", function(d){ return x(d.date) })
        .attr("y", function(d) {return y(d.series)})
              // .attr("r", 2)  
    // svg.select("path.area").attr("d", area);
    // svg.select("path.line").attr("d", line);
  }

}
drawGraphic();
d3.selectAll(".styled-select select")
  .on("change", function(){
    selectSeries(d3.select(".offender-type select").node().value, d3.select(".reduction-type select").node().value, d3.select(".amount-type select").node().value)
  })
// $(window).scroll(function(){
//     var top = ($(window).scrollTop() > 0) ? $(window).scrollTop() : 1;
//     console.log(top)
//     $('.fade').stop(true, true).fadeTo(0, 1 / top);
//     $('.fade').css('top', top * 1.3);             
// });
</script>
